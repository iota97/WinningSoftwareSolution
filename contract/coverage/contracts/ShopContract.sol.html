<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/ShopContract.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> ShopContract.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">44.44% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>20/45</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">16.67% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>4/24</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">50% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>5/10</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">42.55% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>20/47</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">//SPDX-License-Identifier: none
&nbsp;
pragma solidity 0.8.12;
&nbsp;
import "@openzeppelin/contracts/utils/math/SafeMath.sol";
import "@openzeppelin/contracts/utils/Address.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@chainlink/contracts/src/v0.8/interfaces/AggregatorV3Interface.sol";
import "@chainlink/contracts/src/v0.8/KeeperCompatible.sol";
&nbsp;
contract ShopContract is Ownable, KeeperCompatibleInterface {
    using Address for address;
    using SafeMath for uint256;
&nbsp;
    uint256 freePaymentEntryId;
    uint256 freeSettledPaymentId;
    AggregatorV3Interface internal priceFeed;
&nbsp;
    uint256 immutable interval;
    uint256 immutable expireDuration;
    uint256 lastTimeStamp;
    uint256 lastTimeIndex;
&nbsp;
    struct PaymentEntry {
        address seller;
        uint256 price; // Dollars cent
    }
&nbsp;
    struct SettledPayment {
        uint256 paymentEntryId;
        uint256 status; //0 cancelled, 1 paid, 2 money unlocked, 3 timed out
        address client;
        uint256 time;
        uint256 payed; // In Wei
    }
&nbsp;
    mapping(uint256 =&gt; PaymentEntry) private paymentsEntries;
    mapping(uint256 =&gt; SettledPayment) private settledPayments;
&nbsp;
    /**
     * https://docs.chain.link/docs/matic-addresses/
     * Network: Mumbai Testnet
     * Aggregator: MATIC/USD Dec: 8
     * Address: 0xd0D5e3DB44DE05E9F294BB0a3bEEaF030DE24Ada
     */
    constructor(){
        priceFeed = AggregatorV3Interface(0xd0D5e3DB44DE05E9F294BB0a3bEEaF030DE24Ada);
&nbsp;
        interval = 60; // Check every 60 sec, change to 1 hour
        lastTimeStamp = block.timestamp;
        lastTimeIndex = 0;
        freePaymentEntryId = 0;
        freeSettledPaymentId = 0;
        expireDuration = 60*10; // expire after 10 min, change to 14 days
    }
&nbsp;
    event addedPaymentEntry(uint256 paymentEntryId);
    event paymentSettled(uint256 settledPaymentId);
    event statusChanged(uint256 settledPaymentId);
&nbsp;
    function getLatestPrice() public view returns (uint256 p) {
        (,int price,,,) = priceFeed.latestRoundData();
        return (10**24)/uint256(price);
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function checkUpkeep(bytes calldata) external override returns (bool upkeepNeeded, bytes memory) {</span>
<span class="cstat-no" title="statement not covered" >        upkeepNeeded = (block.timestamp - lastTimeStamp) &gt; interval</span>;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function performUpkeep(bytes calldata) external override {</span>
<span class="cstat-no" title="statement not covered" >        if ((block.timestamp - lastTimeStamp) &gt; interval) {</span>
<span class="cstat-no" title="statement not covered" >             uint256 i = lastTimeIndex;</span>
<span class="cstat-no" title="statement not covered" >             while (i &lt; freeSettledPaymentId) {</span>
<span class="cstat-no" title="statement not covered" >                if ((block.timestamp - settledPayments[i].time) &gt; expireDuration) {</span>
<span class="cstat-no" title="statement not covered" >                    if (settledPayments[i].status == 1) {</span>
<span class="cstat-no" title="statement not covered" >                       payable(settledPayments[i].client).transfer(settledPayments[i].payed)</span>;
<span class="cstat-no" title="statement not covered" >                       settledPayments[i].status = 3</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >                       emit statusChanged(i);</span>
                    }
                    i++;
                } else {
                    break;
                }
            }
<span class="cstat-no" title="statement not covered" >            lastTimeIndex = i</span>;
<span class="cstat-no" title="statement not covered" >            lastTimeStamp = block.timestamp</span>;
        }
    }
&nbsp;
    function addPaymentEntry(uint256 price) public {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(price &gt; 0);
        paymentsEntries[freePaymentEntryId] = PaymentEntry(msg.sender, price);
        freePaymentEntryId = freePaymentEntryId + 1;
        emit addedPaymentEntry(freePaymentEntryId - 1);
    }
&nbsp;
    function settlePayment(uint256 paymentEntryId) payable public{
        <span class="missing-if-branch" title="else path not taken" >E</span>require(paymentEntryId &lt; freePaymentEntryId);
        <span class="missing-if-branch" title="else path not taken" >E</span>require(paymentsEntries[paymentEntryId].price*getLatestPrice() &lt;= msg.value);
        settledPayments[freeSettledPaymentId] = SettledPayment(paymentEntryId, 1, msg.sender, block.timestamp, msg.value);
        freeSettledPaymentId = freeSettledPaymentId + 1;
        emit paymentSettled(freeSettledPaymentId - 1);
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function unlockFunds(uint256 settledPaymentId) public {</span>
<span class="cstat-no" title="statement not covered" >        require(settledPayments[settledPaymentId].client == msg.sender)</span>;
<span class="cstat-no" title="statement not covered" >        require(settledPayments[settledPaymentId].status == 1)</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        address payable addr = payable(paymentsEntries[settledPayments[settledPaymentId].paymentEntryId].seller);</span>
<span class="cstat-no" title="statement not covered" >        addr.transfer(settledPayments[settledPaymentId].payed)</span>;
<span class="cstat-no" title="statement not covered" >        settledPayments[settledPaymentId].status = 2</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        emit statusChanged(settledPaymentId);</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function cancelPayment(uint256 settledPaymentId) public {</span>
<span class="cstat-no" title="statement not covered" >        require(paymentsEntries[settledPayments[settledPaymentId].paymentEntryId].seller == msg.sender)</span>;
<span class="cstat-no" title="statement not covered" >        require(settledPayments[settledPaymentId].status == 1)</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        address payable addr = payable(settledPayments[settledPaymentId].client);</span>
<span class="cstat-no" title="statement not covered" >        addr.transfer(settledPayments[settledPaymentId].payed)</span>;
<span class="cstat-no" title="statement not covered" >        settledPayments[settledPaymentId].status = 0</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        emit statusChanged(settledPaymentId);</span>
    }
&nbsp;
    function getPaymentEntry(uint256 paymentEntryId) public view returns(PaymentEntry memory){
        <span class="missing-if-branch" title="else path not taken" >E</span>require(paymentEntryId &lt; freePaymentEntryId);
        return paymentsEntries[paymentEntryId];
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function getSettledPayment(uint256 settledPaymentId) public view returns(SettledPayment memory){</span>
<span class="cstat-no" title="statement not covered" >        require(settledPaymentId &lt; freeSettledPaymentId)</span>;
<span class="cstat-no" title="statement not covered" >        return settledPayments[settledPaymentId];</span>
    }
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Thu Feb 24 2022 17:47:35 GMT+0100 (Ora standard dell’Europa centrale)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
