\documentclass[a4paper, 12pt]{article}

\usepackage{graphicx}
\usepackage{longtable}
\usepackage[font=small,labelfont=bf]{caption}
\graphicspath{ {images/} }

\newcommand{\templates}{../../template}
\input{\templates/style}
\input{\templates/front_page}
\input{\templates/history}

\settitolo{Specifiche Architetturali}
\setprogetto{ShopChain}
\setcommittenti{SyncLab}
\setredattori{Giovanni Cocco}
\setrevisori{Federico Marchi}
\setresponsabili{Giovanni Cocco}
\setdestuso{esterno}
\setdescrizione{
Architettura del progetto
}

\addversione{1.0.0}{23/2/2022}{Giovanni Cocco}{Redazione}{Creazione del documento}

\begin{document}

\makefrontpage

\makeversioni

\tableofcontents
\clearpage

\section{Introduzone}
\subsection{Scopo del documento}
Il documento illustra le scelte architetturali e illustra l'architettura.

\section{Riferimenti}
\subsection{Riferimenti normativi}
\begin{itemize}
    \item \underline{\href{https://www.math.unipd.it/~tullio/IS-1/2021/Progetto/C2.pdf}{Capitolato d'appalto C2}};
    \item \underline{\href{https://github.com/iota97/WinningSoftwareSolution/blob/main/public/interni/norme_di_progetto_v2.0.0.pdf}{Norme di Progetto}};
    \item \underline{\href{https://github.com/iota97/WinningSoftwareSolution/blob/main/public/esterni/verbali/2021_01_03_E.pdf}{Verbale esterno 2021/03/01}}.
\end{itemize}
\subsection{Riferimenti informativi}
\begin{itemize}
    \item \underline{\href{https://www.math.unipd.it/~tullio/IS-1/2021/Dispense/T09.pdf}{Progettazione Software - Materiale didattico del corso IS}};
    \item \underline{\href{https://www.math.unipd.it/~rcardin/swea/2022/Diagrammi\%20di\%20Sequenza.pdf}{Slide diagrammi di sequenza - Materiale didattico del corso IS}};
    \item \underline{\href{https://www.math.unipd.it/~rcardin/swea/2022/Software\%20Architecture\%20Patterns.pdf}{Slide design pattern architetturali - Materiale didattico del corso IS}};
    \item \underline{\href{https://www.math.unipd.it/~rcardin/swea/2021/Diagrammi\%20delle\%20Classi_4x4.pdf}{Slide diagrammi delle classi - Materiale didattico del corso IS}};
    \item \underline{\href{https://www.math.unipd.it/~rcardin/sweb/2022/L03.pdf}{Slide principi SOLID - Materiale didattico del corso IS}}.
\end{itemize}

\section{Tecnologie/Linguaggi/Librerie}

\subsection{Solidity}
\begin{itemize}
\item \textbf{Versione:} 0.8.13
\item \textbf{Documentazione:} \href{https://docs.soliditylang.org/en/v0.8.13/}{https://docs.soliditylang.org/en/v0.8.13/}
\end{itemize}

\subsection{Typescript}
\begin{itemize}
\item \textbf{Versione:} 4.6.3
\item \textbf{Documentazione:} \href{https://www.typescriptlang.org/docs/}{https://www.typescriptlang.org/docs/}
\end{itemize}

\subsection{Express}
\begin{itemize}
\item \textbf{Versione:} 4.17.2
\item \textbf{Documentazione:} \href{https://devdocs.io/express/}{https://devdocs.io/express/}
\end{itemize}

\subsection{MariaDB}
\begin{itemize}
\item \textbf{Versione:} 10.7.3
\item \textbf{Documentazione:} \href{https://mariadb.com/kb/en/documentation/}{https://mariadb.com/kb/en/documentation/}
\end{itemize}

\subsection{Python}
\begin{itemize}
\item \textbf{Versione:} 3.8
\item \textbf{Documentazione:} \href{https://docs.python.org/3.8/}{https://docs.python.org/3.8/}
\end{itemize}

\subsection{Web3}
\begin{itemize}
\item \textbf{Versione:} 1.7.1
\item \textbf{Documentazione:} \href{https://web3js.readthedocs.io/en/v1.7.1/}{https://web3js.readthedocs.io/en/v1.7.1/}
\end{itemize}

\subsection{MetaMask}
\begin{itemize}
\item \textbf{Versione:} 10.11.3
\item \textbf{Documentazione:} \href{https://docs.metamask.io/guide/}{https://docs.metamask.io/guide/}
\end{itemize}

\section{Architettura generale}
Il progetto si compone di 4 macro parti:
\begin{itemize}
\item Server
\item Smart contract
\item Web app
\item Script di messa in vendita
\end{itemize}
\subsection{Server}
Realizzato in typescript con express come modulo http e MariaDB come database SQL.
Si divide in 2 parti principali: la persistenza e il server web.
\subsubsection{Persistenza}
Si occupa di gestire i dati delle transazioni.\\\\
Si collega allo smart contract attraverso un websocket fornito da moralis.io.\\
Rimane in ascolto degli eventi dello smart contract e 
aggiorna il database SQL di conseguenza.\\
Tiene sempre traccia dell'ultimo blocco da cui ha ricevuto un evento
e all'avvio recupera tutti gli eventi arretrati partendo da quest'ultimo blocco.\\\\
I dati nel database SQL vengono forniti al frontend.\\\\
Notare come è molto oneroso
effettuare query sui dati in block chain in quanto non sono disponibili strutture dati adeguate.\\
Questa soluzione ci permette una maggiore flessibilità e apertura a modifiche future quali aggiungere query specifiche.\\\\
Inoltre il contratto una volta publicato non può essere modificabile al fine di garantire la trasparenza ed è quindi cruciale
che il codice di quest'ultimo sia semplice ed affidabile.
\subsubsection{Server Web}
Riceve le richieste HTTP dalla rete e risponde con le pagine della Web app.

\subsection{Smart contract}
Realizzato in solidity e publicato su una rete Polygon tiene traccia delle transazioni; gestisce la logica e la sicurezza di esse.\\\\
Per gestire il timer che fa scadere le transazioni si usa il servizio Upkeeper di ChainLink.\\
Uno smart contract non esegue operazioni se non viene chiamato, per realizzare un timer si realizzano delle funzioni che se è passato abbastanza tempo
eseguono le operazioni. Upkeeper chiama automaticamente queste funzioni dall'esterno a intervalli di tempo prefissato.

\subsection{Web app}
Fornita all'utente tramite il server web fornisce la logica lato client.\\
Tramite MetaMask l'utente interagisce direttamente col contratto.\\\\
In caso di utenti mobile reindirizza tramite DeepLink per aprire la pagine sull'app di Metamask.\\\\
I deep link vengono usati anche per il QR code di ricezione del pacco.\\
Possono essere scansionati sia da dentro l'app di MetaMask che dalla fotocamera del cellulare.

\subsection{Script di messa in vendita}
Usato dall'ecommerce per inserire prodotti in vendita in blockchain al fine di verificare che il prezzo sia corretto al momento della vendita.
Realizzato in python per flessibilità, si connette alla block chain tramite moralis.io.

\section{Dettagli archittettura}
\subsection{Server}
\subsubsection{Diagramma delle classi}
\includegraphics[width=1.0\textwidth]{server_class}
\captionof{figure}{Diagramma delle classi del server}
\paragraph{Commenti}
La classe ShopContract andrà a interfacciarsi con il contratto in blockchain.\\
La classe PageCreator andrà a interfacciarsi con la WebApp.
\subsubsection{Design pattern: Constructor injection}
\paragraph{Descrizione}
Le dipendenze sono tracciate e passate agli oggetti tramite il construttore.
\paragraph{Motivazioni}
Facilità il tracciamento delle dipendenze e agevola il mocking in fase di test.
\subsubsection{Schema DB}
\includegraphics[width=1.0\textwidth]{db}
\captionof{figure}{Schema del DB relazionale}
\paragraph{Commenti}
Schema delle tabelle del database.\\
\textbf{LastSyncedBlock} contiene una sola riga con \textit{id} 0 con il valore dell'ultimo blocco sincronizzato.

\subsection{Smart contract}
\subsubsection{Diagramma delle classi}
\includegraphics[width=1.0\textwidth]{contract}
\captionof{figure}{Diagramma delle classi del contratto}

\paragraph{Commenti}
\subsubsection{Pattern architetturale adottato}
\paragraph{Descrizione}
\paragraph{Motivazioni}

\subsection{Web app}
\subsubsection{Diagramma delle classi}
[grafico]
\paragraph{Commenti}
\subsubsection{Pattern architetturale adottato}
\paragraph{Descrizione}
\paragraph{Motivazioni}

\subsection{Script di messa in vendita}
\subsubsection{sell\_item}
\textbf{Parametri}\\
price: float - il prezzo in dollari della entry di pagamento.\\\\
\textbf{Valore Restituito}\\
entry id: int - l'id dell'entry inserita in blockchain (-1 in caso di errore).\\\\
\textbf{Comportamento}\\
Il metodo inserisce una nuova entry di pagamento in blockchain con il prezzo specificato.\\
Sia in caso si successo che di errore tutte le informazione vengono salvate nel file \textit{sell.log}.

\section{Diagrammi di sequenza}
\subsection{Inizializzazione server web}
\includegraphics[width=1.0\textwidth]{server}
\captionof{figure}{Diagramma di sequenza dell'inizializzazione del server}
\paragraph{Commenti}
Mostra l'inizializzazione delle routes per express.

\subsection{Ascolto eventi del contratto}
\includegraphics[width=1.0\textwidth]{shopContractEventManager}
\captionof{figure}{Diagramma di sequenza dell'ascolto degli eventi}
\paragraph{Commenti}
Mostra la sottoscrizione degli eventi del contratto.

\subsection{Nuovo oggetto in vendita}
\includegraphics[width=1.0\textwidth]{addedPaymentEntry}
\captionof{figure}{Diagramma di sequenza di un nuovo oggetto in vendita}
\paragraph{Commenti}
Mostra cosa succede quando viene inserito una nuova entry di pagamento da parte di un e-commerce.

\subsection{Nuova transazione}
\includegraphics[width=1.0\textwidth]{settledPayment}
\captionof{figure}{Diagramma di sequenza di una nuova transazione}
\paragraph{Commenti}
Mostra cosa succede quando viene create una nuova transazione.

\subsection{Cambio di stato di una transazione}
\includegraphics[width=1.0\textwidth]{statusChanged}
\captionof{figure}{Diagramma di sequenza del cambio di stato di una transazione}
\paragraph{Commenti}
Mostra cosa succede quando una transazione cambia di stato.

\subsection{Pagina transazioni in entrata}
\includegraphics[width=1.0\textwidth]{paymentBySellerPage}
\captionof{figure}{Diagramma di sequenza della richeista della pagina delle transazioni in entrata}
\paragraph{Commenti}
Mostra cosa succede quando un utente richiede la pagina delle transazione in entrata.\\
Le altre pagine utilizzano lo stesso modello e dunque si preferisce evitare diagrammi di sequenza ridondanti.

\end{document}